var list=[];var editorId="#comment_content";var verifycodeId="#img_verifycode";var listId="#comment_list";$(document).ready(init_comment);function init_comment(){load_comment_form();editor=$(editorId);var a=null;if(editor.length>0){$("#lang_list").append('<a class="long_name" href="#html">HTML/XML</a><a class="long_name" href="#objc">objective-c</a><a class="zhong_name" href="#delphi">Delphi</a><a  class="zhong_name" href="#ruby">Ruby</a><a href="#php">PHP</a><a class="duan_name" href="#csharp">C#</a><a style=" border-right: none;"  class="duan_name" href="#cpp">C++</a><a style=" border-bottom:none;"class="long_name" href="#javascript">JavaScript</a><a style=" border-bottom:none;" class="long_name" href="#vb">Visual Basic</a><a style=" border-bottom:none;" class="zhong_name" href="#python">Python</a><a style=" border-bottom:none;" class="zhong_name" href="#java">Java</a><a style="border-bottom:none;" class="duan_name" href="#css">CSS</a><a style="border-bottom:none;" class="duan_name" href="#sql">SQL</a><a style="border:none;"  class="duan_name" href="#plain">其它</a>');editor.focus(function(){a=setInterval(function(){commentTip("还能输入"+(1000-editor.val().length)+"个字符")},200)}).blur(function(){if(a){clearInterval(a)}})}loadList(1)}function noComments(){$(listId).html('<br />&nbsp;&nbsp;暂无评论<br /><br /><div class="clear"></div>')}function loadList(pageIndex,isSub){if(commentscount==0){noComments();return}pageIndex=parseInt(pageIndex)||1;$("#comments_bar").html("正在加载评论...");var cmtUrl="../../comment/list/"+fileName+"?page="+(pageIndex||1);if(isSub){cmtUrl+="&_"+Math.random()}$.get(cmtUrl,function(json){if(!json){noComments();return}var data=(typeof json=="object")?json:eval("("+json+")");if(isSub){list=data.list}else{list=list.concat(data.list)}var listHtml="";var topics=getTopics(list);var total=data.total>0?data.total:topics.length;for(var i=0;i<topics.length;i++){var comment=topics[i];var layer=total-i;listHtml+=getItemHtml(comment,layer)}listHtml+='<div class="clear"></div>';$(listId).html(listHtml);dp.SyntaxHighlighter.HighlightAll("code2");new CNick(listId+" a.username").showNickname();if(data.page.PageIndex>=data.page.PageCount){$("#comment_bar").hide()}else{$("#comment_bar").html('<div id="load_comments" page="'+(pageIndex+1)+'">查看更多评论</div>')}setBtnEvent()})}function getTopics(c){var d=[];for(var b=0;b<c.length;b++){var a=c[b];if(a.ParentId==0){a.Replies=getReplies(a,c);d.push(a)}}return d}function getReplies(d,e){var c=[];for(var a=0;a<e.length;a++){var b=e[a];if(b.ParentId==d.CommentId){b.Replies=getReplies(b,e);c.push(b)}}return c}function getItemHtml(g,d,f,a){if(!a){a=0}var b=a>3?' style="margin-left:0;"':"";var e='<dl class="comment_item comment_'+(g.ParentId>0?"reply":"topic")+'" id="comment_item_{id}"'+b+'><dt class="comment_head" floor='+(f||d)+">"+(g.ParentId>0?"Re:":d+"楼")+' <span class="user">';if(g.UserName!=null&&g.UserName!=""){e+='<a class="username" href="/'+g.UserName+'" target="_blank">'+g.UserName+"</a>"}else{e+="[游客]"}e+=" <span class='ptime'>"+g.PostTime+"发表</span> ";e+=' <a href="#reply" class="cmt_btn reply" title="回复">[回复]</a> <span class="comment_manage" style="display:none;" commentid={id} username={username}> <a href="#quote" class="cmt_btn quote" title="引用">[引用]</a> <a href="#report" class="cmt_btn report" title="举报">[举报]</a>';if(username==currentUserName||g.UserName==currentUserName){e+=' <a href="#delete" class="cmt_btn delete" title="删除">[删除]</a>'}e+="</span></dt>";e+='<dd class="comment_userface"><a href="/'+g.UserName+'" target="_blank"><img src="'+g.Userface+'" width="40" height="40" /></a></dd>';e+='<dd class="comment_body">'+replaceUBBToHTML(g)+"</dd>";e=e.replace(/\{id\}/g,g.CommentId).replace(/\{username\}/g,g.UserName);if(g.Replies!=null){for(var c=0;c<g.Replies.length;c++){e+=getItemHtml(g.Replies[c],c+1,d,a+1)}}e+="</dl>";return e}function getComment(b,c){for(var a=0;a<c.length;a++){var d=c[a];if(d.CommentId==b){return d}}return null}function setBtnEvent(){$("#load_comments").click(function(){var a=$(this).attr("page");loadList(a)});$(".comment_head a").click(function(){var b=$(this).attr("href");b=b.substring(b.lastIndexOf("#"));var a=$(this).parent().attr("commentid");switch(b){case"#reply":if(currentUserName){a=$(".comment_manage",$(this).parent()).attr("commentid");replyComment(a,list);setEditorFocus()}return true;case"#quote":if(currentUserName){quoteComment(a,list);setEditorFocus()}return true;case"#report":reportComment(a,this);break;case"#delete":deleteComment(a);break;default:return true}return false});$(".comment_item").mouseover(function(){$(".comment_manage",$(this)).eq(0).show()}).mouseout(function(){$(".comment_manage",$(this)).eq(0).hide()})}function setEditorFocus(){var a=editor.val();editor.val("");editor.focus();editor.val(a)}function quoteComment(a,c){var d=getComment(a,c);var b=d.Content;if(d.Content.length>50){b=d.Content.substring(0,50)+"..."}editor.val("[quote="+(d.UserName==null?"游客":d.UserName)+"]"+b+"[/quote]\r\n")}function replyComment(a,b){var c=getComment(a,b);editor.val("[reply]"+c.UserName+"[/reply]\r\n");$("#comment_replyId").val(a)}function reportComment(a,b){report(a,3,b)}function deleteComment(a){if(!confirm("你确定要删除这篇评论吗？")){return}var b=blog_address+"/comment/delete?commentid="+a+"&filename="+fileName;$.get(b,function(c){if(c.result==1){$("#comment_item_"+a).hide().remove()}else{alert("你没有删除该评论的权限！")}})}function replaceUBBToHTML(f){var d=$.trim(f.Content);var c=/\[code=([\w#\.]+)\]([\s\S]*?)\[\/code\]/ig;var e=[];while((mc=c.exec(d))!=null){e.push(mc[0]);d=d.replace(mc[0],"--code--")}d=replaceQuote(d);d=d.replace(/\[reply]([\s\S]*?)\[\/reply\][\r\n]{0,2}/gi,"回复$1：");d=d.replace(/\[url=([^\]]+)]([\s\S]*?)\[\/url\]/gi,'<a href="$1" target="_blank">$2</a>');d=d.replace(/\[img(=([^\]]+))?]([\s\S]*?)\[\/img\]/gi,'<img src="$3" style="max-width:400px;max-height:200px;" border="0" title="$2" />');d=d.replace(/\r?\n/ig,"<br />");if(e.length>0){var b=/--code--/ig;var a=0;while((mc=b.exec(d))!=null){d=d.replace(mc[0],e[a]);a++}}d=d.replace(/\[code=([\w#\.]+)\]([\s\S]*?)\[\/code\]/ig,function(i,h,g){if($.trim(g)==""){return""}return'<pre name="code2" class="'+h+'">'+g+"</pre>"});return d}function replaceQuote(b){var a=/\[quote=([^\]]+)]([\s\S]*)\[\/quote\]/gi.exec(b);if(a){return b.replace(a[0],"<fieldset><legend>引用“"+a[1]+"”的评论：</legend>"+replaceQuote(a[2])+"</fieldset>")}else{return b}}function load_comment_form(){var a=getcookie("UserName").toLowerCase();if(islock){$("#comment_form").html("<div class='notice'>该文章已被禁止评论！</div>")}else{if(currentUserName||(a!=null&&a!=""&&a!=undefined)){var c='<a name="commentbox"></a><a name="reply"></a><a name="quote"></a><form action="/'+username+"/comment/submit?id="+fileName+'" method="post" onsubmit="return subform(this);"><div class="commentform"><div class="panel_head">发表评论</div><ul><li class="left">用 户 名：</li><li class="right">'+currentUserName+'</li></ul><ul><li class="left">评论内容：</li><li class="right" style="position:relative;"><div id="ubbtools"><a href="#insertcode" code="code"><img src="'+static_host+'/images/ubb/code.gif" border="0" alt="插入代码" title="插入代码"/></a></div><div id="lang_list" style="position: absolute; top: 28px; left: 0px; display: none;"></div><textarea class="comment_content" name="comment_content" id="comment_content" style="width: 400px; height: 200px;"></textarea></li></ul><ul><input type="hidden" id="comment_replyId" name="comment_replyId" /><input type="hidden" id="comment_userId" name="comment_userId" value="521203" /><input type="hidden" id="commentId" name="commentId" value="" /><input type="submit" class="comment_btn" value="提交" />&nbsp;&nbsp;<span id="tip_comment" style="color: Red; display: none;"></span></ul></div></form>';$("#comment_form").html(c)}else{var b=encodeURIComponent(location.href);$("#comment_form").html('<div class="guest_link">您还没有登录,请<a href="javascript:void(0);" onclick="javascript:loginbox();">[登录]</a>或<a href="http://passport.csdn.net/account/register?from='+b+'">[注册]</a></div>')}}ubb_event()}function getcookie(c){var b=document.cookie.indexOf(c);var a=document.cookie.indexOf(";",b);return b==-1?"":unescape(document.cookie.substring(b+c.length+1,(a>b?a:document.cookie.length)))}var c_doing=false;function subform(d){if(c_doing){return false}var c=$.trim($(editorId).val());if(c==""){commentTip("评论内容没有填写!");return false}else{if(c.length>1000){commentTip("评论内容太长了，不能超过1000个字符！");return false}}var b=$("#commentId").val();commentTip("正在发表评论...");var a=new Date();$(editorId).attr("disabled",true);$("button[type=submit]",d).attr("disabled",true);c_doing=true;$.ajax({type:"POST",url:$(d).attr("action"),data:{commentid:b,content:c,replyId:$("#comment_replyId").val()},success:function(f){c_doing=false;commentTip(f.content);if(f.result){var e=$("#comment_replyId").val();$(editorId).val("");$("#comment_replyId,#comment_verifycode").val("");commentscount++;loadList(1,true);$(editorId).attr("disabled",false);$("button[type=submit]",d).attr("disabled",false);commentTip("发表成功！评论耗时:"+(new Date()-a)+"毫秒");if(e!=undefined&&e!=""){$("html,body").animate({scrollTop:$("#comment_item_"+e).offset().top},1000)}}}});return false}var _c_t;function commentTip(a){$("#tip_comment").html(a).show();clearTimeout(_c_t);_c_t=setTimeout(function(){$("#tip_comment").hide()},10000)}function ubb_event(){$("#ubbtools").children().click(function(){var a=editor.selection();editor.focus();var c=$(this).attr("code");switch(c){case"code":var b=$("#lang_list");b.show();b.children().each(function(){$(this).unbind("click").click(function(){editor.val("[code="+$.trim(this.href.split("#")[1])+"]\n"+a+"\n[/code]");b.hide()})});editor.click(function(d){b.hide()});break;default:editor.val("["+c+"]"+a+"[/"+c+"]");break}return false})};